<!DOCTYPE html>
<html lang="en" style="height: 100%;">
    <head>
        <meta charset="UTF-8">
        <title>Gravity</title>
    </head>



    <body style="background-color: black;width: 100%;height: 100%;">

        <input type="checkbox" value="checkbox" id="checkbox"><font color="white">不显示轨迹</font> <br>
        <canvas id="canvas" width="100%" height="100%" style="border: 1px solid white"></canvas>

    </body>
    <!-- <script src="js/jquery-3.7.1.min.js"></script> -->

    <script type="text/javascript">
        var ps = new Array();
        var sps =[];

        var planetsNumber = 100;
        var minVx = -15;
        var maxVx = 15;
        var minVy = -15;
        var maxVy = 15;

        var minRadius = 5;
        var maxRadius = 10;

        var queueSize = 200;

        var density = 20;//density = mass/radius

        var pid = 0;

        var G = 1;


        class Node{
            constructor(data,next){
                this.next = next
                this.data = data
            }
        }
        class Queue{
            constructor(){
                this.head = undefined;
                this.tail = undefined;
            }
            push(data){
                if(!this.head){
                    this.head = new Node(data)
                    this.tail = this.head;
                }else{
                    var node = new Node(data);
                    this.tail.next = node;
                    this.tail = node;
                }
            }
            pop(){
                var data = undefined;
                if(this.head){
                    data = this.head.data
                    this.head = this.head.next;
                }
                return data

            }
            toArray(){
                var array = new Array();
                var p = this.head;
                while(p){
                    array.push(p.data)
                    p = p.next
                }
                return array;
            }
            size(){
                var p = this.head;
                var size = 0;
                while(p){
                    p = p.next
                    size++
                }
                return size
            }
        }
        class Planet {
            move(){

                this.x += 0.1*this.vx
                this.y += 0.1*this.vy

                this.trackX.push(this.x);
                this.trackY.push(this.y);
                if(this.trackX.size() > queueSize){
                    this.trackX.pop();
                    this.trackY.pop();
                }

            }
            changeSpeed(){
                this.vx += 10*this.fx/this.m;
                this.vy += 10*this.fy/this.m;
            }
            constructor(x,y,r,vx,vy){
                this.id = pid;
                pid++;

                this.m = density*r;

                this.x = x;
                this.y = y;
                this.r = r;

                this.fx = 0;
                this.fy = 0;

                this.vx = vx?vx:0;
                this.vy = vy?vy:0;

                this.trackX = new Queue();
                this.trackY = new Queue();

                switch (Math.floor(Math.random() * 9)) {
                    case 0:
                        this.color = "aqua";
                        break;
                    case 1:
                        this.color = "lightskyblue";
                        break;
                    case 2:
                        this.color = "darkorange";
                        break;
                    case 3:
                        this.color = "gold";
                        break;
                    case 4:
                        this.color = "lawngreen";
                        break;
                    case 5:
                        this.color = "mediumblue";
                        break;
                    case 6:
                        this.color = "red";
                        break;
                    case 7:
                        this.color = "white";
                        break;
                    case 8:
                        this.color = "deeppink";
                        break;
                }
            }
        }

        class StaticPlanet {

            constructor(x,y,r){
                this.m = 3*r;
                this.x = x;
                this.y = y;
                this.r = r;
                switch (Math.floor(Math.random() * 7)) {
                    case 0:
                        this.color = "aqua";
                        break;
                    case 1:
                        this.color = "lightskyblue";
                        break;
                    case 2:
                        this.color = "darkorange";
                        break;
                    case 3:
                        this.color = "gold";
                        break;
                    case 4:
                        this.color = "lawngreen";
                        break;
                    case 5:
                        this.color = "mediumblue";
                        break;
                    case 6:
                        this.color = "red";
                        break;
                }

            }

        }

        function random(range1,range2){
            return Math.floor(range1+Math.random() * (range2-range1))
        }


    </script>

    <script type="text/javascript">

        // var sp1 = new StaticPlanet(1500,800,90);

        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");

        //============================================================

        setForce = function(planets){

            for (var i = 0; i <planets.length ; i++) {
                var tempForce = 0;
                var tempForceX = 0;
                var tempForceY = 0;

                for (var j = 0; j <planets.length ; j++) {

                    if(i!=j){

                        var deltaX = planets[j].x - planets[i].x;
                        var deltaY = planets[j].y - planets[i].y;

                        tempForce = (planets[i].m*planets[j].m*G)/(deltaX*deltaX+deltaY*deltaY);
                        tempForceX += (tempForce*deltaX)/Math.sqrt((deltaX*deltaX + deltaY*deltaY));
                        tempForceY += (tempForce*deltaY)/Math.sqrt((deltaX*deltaX + deltaY*deltaY));
                        
                        if((deltaX*deltaX+deltaY*deltaY)<(planets[i].r+planets[j].r)*(planets[i].r+planets[j].r)){

                            if(planets[i].m > planets[j].m ){

                                planets[i].vx = ((planets[j].m*planets[j].vx)+(planets[i].m*planets[i].vx))/(planets[i].m+planets[j].m);
                                planets[i].vy = ((planets[j].m*planets[j].vy)+ (planets[i].m*planets[i].vy))/(planets[i].m+planets[j].m);
                                planets[i].m += planets[j].m;
                                planets[i].r = planets[i].m/density;
                                ps.splice(j,1);
                            }else{

                                planets[j].vx = ((planets[i].m*planets[i].vx) + (planets[j].m*planets[j].vx))/(planets[i].m+planets[j].m);
                                planets[j].vy = ((planets[i].m*planets[i].vy)+ (planets[j].m*planets[j].vy))/(planets[i].m+planets[j].m);
                                planets[j].m += planets[i].m;
                                planets[j].r = planets[j].m/density;
                                ps.splice(i,1);
                            }

                        }

                    }

                }

                for (var j = 0; j < sps.length; j++) {

                    var deltaX = sps[j].x - planets[i].x;
                    var deltaY = sps[j].y - planets[i].y;

                    if((deltaX*deltaX+deltaY*deltaY)<(planets[i].r+sps[j].r)*(planets[i].r+sps[j].r)) {

                        if (planets[i].m > sps[j].m) {

                            planets[i].vx = (planets[i].m * planets[i].vx) / (planets[i].m + sps[j].m);
                            planets[i].vy = (planets[i].m * planets[i].vy) / (planets[i].m + sps[j].m);
                            planets[i].m += sps[j].m;
                            planets[i].r = planets[i].m / 3;
                            sps.splice(j, 1);
                        } else {

                            sps[j].m += planets[i].m;
                            sps[j].r = sps[j].m / 3;
                            ps.splice(i, 1);
                        }

                    }

                    tempForce = (planets[i].m*sps[j].m)/(deltaX*deltaX+deltaY*deltaY);
                    tempForceX += (tempForce*deltaX)/Math.sqrt((deltaX*deltaX + deltaY*deltaY));
                    tempForceY += (tempForce*deltaY)/Math.sqrt((deltaX*deltaX + deltaY*deltaY));

                }
                planets[i].fx = tempForceX;
                planets[i].fy = tempForceY;

            }

        }
        /*
        画出所有星及其轨迹的函数

        canvas.width = canvas.width;用来不断刷新画布达到动态效果
        第一个for画静态星
        第二个for画动态星

        每画一次，都把星当前的坐标储存起来，然后调for循环把所有点连成直线，即轨迹

         */
        draw = function(ps,sps){
            canvas.width = canvas.width;

            for (var i = 0; i < sps.length; i++) {
                context.beginPath();
                context.fillStyle= sps.color;
                context.arc(sps[i].x,sps[i].y,sps[i].r,0,2*Math.PI);
                context.closePath();
                context.fill();
            }


            for (var i = 0; i <ps.length; i++) {

                context.beginPath();
                context.fillStyle = ps[i].color;
                context.arc(ps[i].x,ps[i].y,ps[i].r,0,2*Math.PI);
                context.closePath();
                context.fill();

                if(document.getElementById("checkbox").checked){
                    ps[i].trackX.length = 0;
                    ps[i].trackY.length = 0;

                }else{

                    context.moveTo(ps[i].x, ps[i].y);
                    context.beginPath();
                    context.strokeStyle = ps[i].color;

                    var xArray = ps[i].trackX.toArray();
                    var yArray = ps[i].trackY.toArray();

                    for(var j = 0;j<xArray.length;j++){
                        context.lineTo(xArray[j],yArray[j]);
                    }

                    context.stroke();

                }

                //将所有星的参数显示到画布
                // context.beginPath();
                // context.fillStyle = ps[i].color;
                // context.font = "20px Georgia";
                // context.fillText(" id:"+ps[i].id,20,40+i*80);
                // context.fillText(" m:"+ps[i].m,20,60+i*80);
                // context.fillText(" vx:"+ps[i].vx.toExponential(3).substring(0,5),20,80+i*80);
                // context.fillText(" vy:"+ps[i].vy.toExponential(3).substring(0,5),20,100+i*80);

            }


        }
        //=============================================================
        function resizeCanvas() {
            document.getElementById("canvas").setAttribute("width", window.innerWidth);
            document.getElementById("canvas").setAttribute("height", window.innerHeight);
        };
        window.onload = function () {
        //添加窗口尺寸改变响应监听

        window.onresize = function(){
            resizeCanvas()
        }

        //页面加载后先设置一下canvas大小
        resizeCanvas();


        for(var i = 0;i<planetsNumber;i++){
            var x = random(100,window.innerWidth);
            var y = random(100,window.innerHeight);
            var vx = random(minVx,maxVx);
            var vy = random(minVy,maxVy);
            var r = random(minRadius,maxRadius);
            ps[i] = new Planet(x,y,r,vx,vy);
        }


            var isMousedown = false;

            document.getElementById("canvas").onmousedown = function(){

                var e = event || window.event;
                isMousedown = true;
                mouseDownX = e.clientX;
                mouseDownY = e.clientY;

            }
            document.getElementById("canvas").onmouseup = function(){
                var e = event || window.event;

                var vx = (e.clientX- mouseDownX)/10;
                var vy = (e.clientY- mouseDownY)/10;
                var p = new Planet(mouseDownX,mouseDownY,8);

                p.vx = vx;
                p.vy = vy;
                ps.push(p);

                isMousedown = false;
            }

            document.getElementById("canvas").onmousemove = function(){
                if (isMousedown) {
                    var e = event || window.event;
                    context.beginPath();
                    context.strokeStyle = "white";
                    context.moveTo(mouseDownX,mouseDownY);
                    context.lineTo(e.clientX,e.clientY);
                    context.stroke();

                    var vx = (e.clientX- mouseDownX);
                    var vy = (e.clientY- mouseDownY);

                    context.beginPath();
                    context.fillStyle = "white";
                    context.fillText(" vx:"+vx,e.clientX,e.clientY);
                    context.fillText(" vy:"+vy,e.clientX,e.clientY+50);
                }
            }

            window.setInterval("setForce(ps)",1);

            ps.forEach(function(planet){
                setInterval(function(p){
                    p.move()
                },1,planet)
                setInterval(function(p){
                    p.changeSpeed()
                },1,planet)
            }); 

            window.setInterval("draw(ps,sps)",1);

        }

    </script>
</html>